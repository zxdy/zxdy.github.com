<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">





  
  
  <link rel="canonical" href="http://yoursite.com/page/2/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Hexo</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/01/15/file-read-write-compare/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ario">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2015/01/15/file-read-write-compare/" class="post-title-link" itemprop="url">大文件读写效率比较</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2015-01-15 00:00:00" itemprop="dateCreated datePublished" datetime="2015-01-15T00:00:00+08:00">2015-01-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-04-09 14:35:01" itemprop="dateModified" datetime="2019-04-09T14:35:01+08:00">2019-04-09</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前做到一个大日志文件（size &gt; 1G）解析的项目，在此记录下对于大文本解析方式的效率比较。不同方式的性能差别很大，那个项目的日志解析时间能从原来的超过36小时优化到只需要2分钟，awk功不可没。</p>
<h2 id="bash-比较"><a href="#bash-比较" class="headerlink" title="bash 比较"></a>bash 比较</h2><p>bash脚本中对于文本的读取主要有以下四种，尽管 AWK 具有完全属于其本身的语法，但在此我也把它归在一起：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#方法一</span></span><br><span class="line"><span class="function"><span class="title">func1</span></span>()&#123;</span><br><span class="line">    rm -f <span class="variable">$2</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$(date)</span> start to read"</span></span><br><span class="line">    start_time=$(date +%s)</span><br><span class="line">    cat <span class="variable">$1</span>|<span class="keyword">while</span> <span class="built_in">read</span> Line</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$Line</span> &gt;&gt; <span class="variable">$2</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    end_time=$(date +%s)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$(date)</span> end to read"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"cost: "</span>$((end_time-start_time))<span class="string">"sec"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#方法二</span></span><br><span class="line"><span class="function"><span class="title">func2</span></span>()&#123;</span><br><span class="line">    rm -f <span class="variable">$2</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$(date)</span> start to read"</span></span><br><span class="line">    start_time=$(date +%s)</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">read</span> Line</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$Line</span> &gt;&gt; <span class="variable">$2</span></span><br><span class="line">    <span class="keyword">done</span> &lt;<span class="variable">$1</span></span><br><span class="line">    end_time=$(date +%s)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$(date)</span> end to read"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"cost: "</span>$((end_time-start_time))<span class="string">"sec"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#方法三</span></span><br><span class="line"><span class="function"><span class="title">func3</span></span>()&#123;</span><br><span class="line">    rm -f <span class="variable">$2</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$(date)</span> start to read"</span></span><br><span class="line">    start_time=$(date +%s)</span><br><span class="line">    <span class="keyword">for</span> Line <span class="keyword">in</span> `cat <span class="variable">$1</span>`</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$Line</span> &gt;&gt; <span class="variable">$2</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    end_time=$(date +%s)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$(date)</span> end to read"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"cost: "</span>$((end_time-start_time))<span class="string">"sec"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#func4</span></span><br><span class="line"><span class="function"><span class="title">func4</span></span>()&#123;</span><br><span class="line">    rm -f <span class="variable">$2</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$(date)</span> start to read"</span></span><br><span class="line">    start_time=$(date +%s)</span><br><span class="line">    awk <span class="string">'&#123;print $0&#125;'</span> <span class="variable">$1</span> &gt; <span class="variable">$2</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$(date)</span> end to read"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"cost: "</span>$((end_time-start_time))<span class="string">"sec"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span>=<span class="variable">$1</span></span><br><span class="line">dest=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#比较结果：</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"####cat read: "</span></span><br><span class="line">func1 <span class="variable">$source</span> <span class="variable">$dest</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"####redirect read: "</span></span><br><span class="line">func2 <span class="variable">$source</span> <span class="variable">$dest</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"####for read: "</span></span><br><span class="line">func3 <span class="variable">$source</span> <span class="variable">$dest</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"####awk read: "</span></span><br><span class="line">func4 <span class="variable">$source</span> <span class="variable">$dest</span></span><br></pre></td></tr></table></figure>
<p>结果:</p>
<p>cat read:</p>
<blockquote>
<p>Thu Jan 15 07:57:50 GMT 2015 start to read</p>
</blockquote>
<blockquote>
<p>Thu Jan 15 07:58:33 GMT 2015 end to read</p>
</blockquote>
<blockquote>
<p>cost: 43sec</p>
</blockquote>
<p>redirect read:</p>
<blockquote>
<p>Thu Jan 15 07:58:33 GMT 2015 start to read</p>
</blockquote>
<blockquote>
<p>Thu Jan 15 07:59:01 GMT 2015 end to read</p>
</blockquote>
<blockquote>
<p>cost: 28sec</p>
</blockquote>
<p>for read:</p>
<blockquote>
<p>Thu Jan 15 07:59:01 GMT 2015 start to read</p>
</blockquote>
<blockquote>
<p>Thu Jan 15 08:00:00 GMT 2015 end to read</p>
</blockquote>
<blockquote>
<p>cost: 59sec</p>
</blockquote>
<p>awk read:</p>
<blockquote>
<p>Thu Jan 15 08:00:00 GMT 2015 start to read</p>
</blockquote>
<blockquote>
<p>Thu Jan 15 08:00:00 GMT 2015 end to read</p>
</blockquote>
<blockquote>
<p>cost: 0sec</p>
</blockquote>
<p>从以上结果可以看出，awk的效率远超其他方法</p>
<h2 id="python-比较"><a href="#python-比较" class="headerlink" title="python 比较"></a>python 比较</h2><p>python 有三种读取文件的方法：</p>
<ul>
<li>read() 会将所有内容读入到一个字符串中</li>
<li>readline() 每次读取一行</li>
<li>readlines() 将所有内容按行读取，返回一个列表，列表中每个元素是一个字符串，一个字符串是一行内容</li>
</ul>
<p>所以从效率上讲， read() 和readlines()会比readline()高，但是同时对内存的要求也比较高，需要能一次性将文件内容放入内存中。但是如果这个文件很大的话，就会影响到程序运行的速度，甚至会导致程序挂掉，此时分行读取或是设置buff_size会是个更好的选择<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func1</span><span class="params">(source,dest)</span>:</span></span><br><span class="line">    os.remove(dest)</span><br><span class="line">    <span class="keyword">with</span> open(source, <span class="string">'r'</span>) <span class="keyword">as</span> fr:</span><br><span class="line">        content=fr.read()</span><br><span class="line">    <span class="keyword">with</span> open(dest,<span class="string">'w'</span>) <span class="keyword">as</span> fw:</span><br><span class="line">        fw.write(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span>  <span class="title">func2</span><span class="params">(source,dest)</span>:</span></span><br><span class="line">    os.remove(dest)</span><br><span class="line">    fw=open(dest,<span class="string">'w'</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> open(source,<span class="string">'r'</span>):</span><br><span class="line">        fw.write(line)</span><br><span class="line">    fw.close</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">from</span> timeit <span class="keyword">import</span> Timer</span><br><span class="line">    t1=Timer(<span class="string">"func1('log','log1')"</span>,<span class="string">"from __main__ import func1"</span>)</span><br><span class="line">    t2=Timer(<span class="string">"func2('log','log1')"</span>,<span class="string">"from __main__ import func2"</span>)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"read once: "</span>+str(t1.timeit(<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"read line: "</span>+str(t2.timeit(<span class="number">1</span>))</span><br></pre></td></tr></table></figure></p>
<p>40M文件5次处理时间：</p>
<blockquote>
<p>read once: 0.308089971542</p>
</blockquote>
<blockquote>
<p>read line: 1.17492413521</p>
</blockquote>
<p>1G文件首次处理时间：</p>
<blockquote>
<p>read once: 8.17146706581</p>
</blockquote>
<blockquote>
<p>read line: 4.13687205315</p>
</blockquote>
<p>1G文件5次处理时间：</p>
<blockquote>
<p>read once: 7.32681894302</p>
</blockquote>
<blockquote>
<p>read line: 30.3610920906</p>
</blockquote>
<p>有意思的是，虽然一次性读入内存效率比line by line读取的效率差，但是假如重复处理同一个文件，一次性读取的总体效率反而高，所以python应该做了类似于缓存的机制。所以当我们用python处理大文本文件的时候需要综合考虑服务器内存，文件处理次数来决定使用哪种方式。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/01/13/python-timeit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ario">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2015/01/13/python-timeit/" class="post-title-link" itemprop="url">python的两种计时方法</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2015-01-13 00:00:00" itemprop="dateCreated datePublished" datetime="2015-01-13T00:00:00+08:00">2015-01-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-04-09 14:34:45" itemprop="dateModified" datetime="2019-04-09T14:34:45+08:00">2019-04-09</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>其实我本意是就贴一段代码完事，但又觉得确实有点干巴巴，还是稍微灌点水吧。</p>
<p>way1和way2分别代表了两种不同的计时方式，同时也展现了两种不同的用途。</p>
<p>way1是使用了timeit包。Python 社区有句俗语：”Python 自己带着电池。” 别自己写计时框架。Python 2.7 具备一个叫做 timeit 的完美计时工具。看demo代码可以发现，它不仅支持对单个方法计时，还支持方法传参，更支持重复计时。我觉得这个计时方法更加适用于测试，特别是性能测试的时候。</p>
<p>way2没什么好说的，一种很简单粗暴傻瓜化的计时方法，换种编程语言也是相同的套路。这个计时方法相比way1来说，更加浅显易懂，操作也简单，就是代码量相对较多，不够简洁。但它也不是没有市场，比较适合在python脚本中写日志。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> timeit <span class="keyword">import</span> Timer</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func1</span><span class="params">(x)</span>:</span></span><br><span class="line">    sum=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span>  xrange(x*<span class="number">10000</span>):</span><br><span class="line">        sum=sum+i</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func2</span><span class="params">(x,y)</span>:</span></span><br><span class="line">    sum=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span>  xrange((x+y)*<span class="number">10000</span>):</span><br><span class="line">        sum=sum+i</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment">#way1</span></span><br><span class="line">    t1=Timer(<span class="string">"func1(2)"</span>,<span class="string">"from __main__ import func1"</span>)</span><br><span class="line">    t2=Timer(<span class="string">"func2(3,4)"</span>,<span class="string">"from __main__ import func2"</span>)</span><br><span class="line">    print(t1.timeit(<span class="number">1</span>))</span><br><span class="line">    print(t2.timeit(<span class="number">1</span>))</span><br><span class="line">    print(t1.repeat(<span class="number">4</span>,<span class="number">10</span>)) //第一个参数是重复整个测试的次数，第二个参数是每个测试中调用被计时语句的次数</span><br><span class="line"></span><br><span class="line">    <span class="comment">#way2</span></span><br><span class="line">    start = time.clock()</span><br><span class="line">    func1(<span class="number">2</span>)</span><br><span class="line">    elapsed = (time.clock() - start)</span><br><span class="line">    print(<span class="string">"Time used:"</span>, elapsed)</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/12/19/oracle-tunning-index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ario">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/12/19/oracle-tunning-index/" class="post-title-link" itemprop="url">oracle性能优化-索引篇</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2014-12-19 00:00:00" itemprop="dateCreated datePublished" datetime="2014-12-19T00:00:00+08:00">2014-12-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-04-09 14:34:31" itemprop="dateModified" datetime="2019-04-09T14:34:31+08:00">2019-04-09</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>索引是每种数据库都避不开的一个话题。很多人不管是DBA还是开发，对于索引的印象就是：sql慢？加个索引吧。但是为什么加了索引sql就能变快呢？加了索引是不是一定就会变快？怎么加索引效率会最高？</p>
<h2 id="从B-tree索引讲起"><a href="#从B-tree索引讲起" class="headerlink" title="从B-tree索引讲起"></a>从B-tree索引讲起</h2><p>索引就像是一本字典的查询页，你可以通过字母或者是偏旁快速定位需要查询的字。类似通过字母查询的是聚集索引（表中行的物理顺序与键值的逻辑索引顺序相同），反之通过偏旁的是非聚集索引（表中行的物理顺序与键值的逻辑索引顺序不相同）。扯远了，这里要讲的是b-tree索引。</p>
<p>oracle默认建的索引就是b-tree索引，他的工作方式如下：</p>
<p><img src="http://7x2wf2.com1.z0.glb.clouddn.com/B-TREE.png" alt="b-tree"></p>
<ol>
<li><p>很显然索引也是需要占用空间的，只是没有普通数据那么大而已。索引的大小跟数据量以及索引列的多少成正比。</p>
</li>
<li><p>一般来说，还是推荐将索引使用的空间与数据的tablespace分开来，索引建在索引专用的tablespace中，方便维护，同时也有助于查询效率提高。oracle的数据查询说到底就是数据块的读取，查询索引的时候，也是在读取数据块，索引数据块越集中，查询的速度越快，如果索引的数据块跟普通数据块一起放在同一个tablespace中，肯定相对比较分散，影响查询效率。</p>
</li>
<li><p>b-tree索引顾名思义就是一棵树。当我们要查询字段值为”ACER”的时候，oracle首先会读取索引的根节点，如图中的20号数据块。这个数据块中维护着子节点的信息，通过它可以往下找到子节点30号数据块，这个节点维护着下一个节点信息，在此表示所有首字母A-F的索引信息都是它的子节点。然后找到叶子节点39号数据块。这个数据块中包含索引字段值首字母是A-F的所有值以及相对应的rowid。</p>
</li>
<li><p>到此，假如你的sql只是需要查到索引的字段值得话，整个过程就到此结束了。但是如果还要对应的其他字段值，则还需通过上一步得到rowid去数据存储的tablespace中找到相应数据块。</p>
</li>
<li><p>发现什么没有？其实oracle的sql查数据最快的方法是直接用rowid查询啊，连索引扫描的时间都省掉了。  </p>
</li>
</ol>
<h2 id="如何挑选索引列"><a href="#如何挑选索引列" class="headerlink" title="如何挑选索引列"></a>如何挑选索引列</h2><ol>
<li>定义一个主键列，oracle会自动为它建一个unique index</li>
<li>外键列通常是需要建索引的</li>
<li>在经常用到的列上建索引，特别是在where谓词中经常出现的</li>
</ol>
<p>你大概会说上面三点基本就是废话。。</p>
<p>好吧，我们说点不是废话的：索引扫描的三种情形</p>
<h3 id="1-sql所有需要的数据都在索引上"><a href="#1-sql所有需要的数据都在索引上" class="headerlink" title="1. sql所有需要的数据都在索引上"></a>1. sql所有需要的数据都在索引上</h3><p>又分为两种情况：</p>
<ul>
<li><p><strong>index range scan.</strong><br>在上图中，假如只要查询”ACER”,那么oracle只需读取3个block，同时在第三个block中挑出是”ACER”的值就可以了,此时用的就是range scan。</p>
</li>
<li><p><strong>index fast full scan.</strong><br>还是上图，假如需要查询被索引的所有值或是大部分值，oralce优化器会认得此时用 index fast full scan最快，就是不挑了，把索引上的值都扫一遍</p>
</li>
</ul>
<h3 id="2-sql需要的数据不都在索引上"><a href="#2-sql需要的数据不都在索引上" class="headerlink" title="2. sql需要的数据不都在索引上"></a>2. sql需要的数据不都在索引上</h3><p>这个情况是最普遍的，即<em>从B-tree索引讲起</em>的第4点情况，反映在执行计划中就是 TABLE ACCESS BY INDEX ROWID</p>
<h3 id="3-不想走索引，就是这么任性"><a href="#3-不想走索引，就是这么任性" class="headerlink" title="3. 不想走索引，就是这么任性"></a>3. 不想走索引，就是这么任性</h3><p>有时候即使表上有各种索引，oracle优化器还是会认为不走索引反而更快，比如全表扫描（TABLE ACCESS FULL）。</p>
<p>索引不是越多越好，也不是一个复合索引覆盖的列越多越好，需要综合考虑性能。建了索引之后也要查看一下执行计划，是不是确实用到了索引，<br>同时要看下sql的buffer read和physical read跟原先比如何。</p>
<h2 id="bitmap索引稍及"><a href="#bitmap索引稍及" class="headerlink" title="bitmap索引稍及"></a>bitmap索引稍及</h2><p>我并没有用过bitmap索引，经验不多，所以就只能稍微介绍下。</p>
<p>bitmap索引即所谓的位图索引，它和b-tree索引最大的区别是适用于只有几个固定值的列，如性别、婚姻状况等，如果列的取值非常多则适用于b-tree索引。</p>
<p>另外位图索引适合静态数据，而不适合索引频繁更新的列。因为它所造成的行锁比较广，非常坑爹。举个例子，某张表上的性别列上是位图索引，有次将其中某一个人的性别从男改成女时，会将表上所有女性记录加锁，直到commit。可以想象假如更新频繁的话，会出现严重的锁等待事件</p>
<h2 id="监控索引使用情况"><a href="#监控索引使用情况" class="headerlink" title="监控索引使用情况"></a>监控索引使用情况</h2><p>在一个很大的数据库中，可能会有成百上千个索引分布在各个表上。随着时间的过去，可能其中很多索引都已经用不到了。虽然索引可以帮助加快数据查询的速度，但是相应也是有代价的。当表的数据有插入，更新，删除的变化时，表上的索引也需要更新，他会占用cpu和磁盘的资源，索引越多，占用的资源越多。所以对于这些已经没有在被使用的索引，可以删掉，节约资源。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--对单独某个索引启用监控</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">index</span> f_regs_idx1 <span class="keyword">monitoring</span> <span class="keyword">usage</span>; </span><br><span class="line"><span class="comment">--查看索引使用情况（对于在不同schema下的索引需要登录到相应的用户上去查看）</span></span><br><span class="line"><span class="keyword">select</span> index_name, table_name, <span class="keyword">monitoring</span>, used <span class="keyword">from</span> v$object_usage; </span><br><span class="line"></span><br><span class="line"><span class="comment">--批量启用监控</span></span><br><span class="line"><span class="keyword">set</span> pagesize <span class="number">0</span> <span class="keyword">head</span> <span class="keyword">off</span> linesize <span class="number">132</span> </span><br><span class="line">spool enable_mon.sql </span><br><span class="line"><span class="keyword">select</span>   </span><br><span class="line"><span class="string">'alter index '</span> || index_name || <span class="string">' monitoring usage;'</span> </span><br><span class="line"><span class="keyword">from</span> user_indexes; </span><br><span class="line">spool off; </span><br><span class="line"></span><br><span class="line"><span class="comment">--禁用监控 </span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">index</span> f_regs_idx1 <span class="keyword">nomonitoring</span> <span class="keyword">usage</span>;</span><br></pre></td></tr></table></figure>
<h2 id="怎样加快建索引的速度"><a href="#怎样加快建索引的速度" class="headerlink" title="怎样加快建索引的速度"></a>怎样加快建索引的速度</h2><p>参见 <a href="http://zxdy.github.io/articles/speed-up-create-index.html" target="_blank" rel="noopener">oracle 如何加快建立索引的速度
</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/09/19/speed-up-create-index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ario">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/09/19/speed-up-create-index/" class="post-title-link" itemprop="url">oracle 如何加快建立索引的速度</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2014-09-19 00:00:00" itemprop="dateCreated datePublished" datetime="2014-09-19T00:00:00+08:00">2014-09-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-04-09 14:34:09" itemprop="dateModified" datetime="2019-04-09T14:34:09+08:00">2019-04-09</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>通常情况下对oracle的表建立索引的时候并不需要考虑效率问题，这个通常情况指的是相应的表数据在百万级以下。但是一旦数据量大到千万级，亿级甚至更大的时候，我们就不能不考虑新建索引的效率问题，因为当表在建立索引的时候，会产生锁阻塞新数据的更新，如果索引不能很快地建立完毕，会对生产环境造成影响。</p>
<p>#1. PGA设置</p>
<p>hash_area_size： 这个参数控制每个会话的hash内存空间有多大。它也可以在会话级和实例级被修改。默认值是sort area空间大小的两倍<br>sort_area_size:  因为排序通常是在PGA中进行的，需要防止因空间或内存不足导致需要disk排序。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">session</span> <span class="keyword">set</span> workarea_size_policy=<span class="keyword">manual</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">session</span> <span class="keyword">set</span> hash_area_size=<span class="number">100000</span>; </span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">session</span> <span class="keyword">set</span> sort_area_size=<span class="number">2000000000</span>; <span class="comment">-- 在系统可用内存足够的情况下，最大可以到2G</span></span><br></pre></td></tr></table></figure>
<p><em>question</em></p>
<blockquote>
<ol>
<li>什么是PGA</li>
<li>什么是SGA</li>
</ol>
</blockquote>
<p>#2. 增加temp表空间</p>
<p>因为大表的数据量比较大，导致建索引时需要的temp表空间也比较大，一般来说接近索引的大小，没把握的情况下可以估算一下索引的大小先：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> serveroutput <span class="keyword">on</span></span><br><span class="line"><span class="keyword">declare</span>  </span><br><span class="line"> v_ddl <span class="built_in">varchar</span>(<span class="number">1024</span>);  </span><br><span class="line"> v_used_bytes number;  </span><br><span class="line"> v_alloc_bytes number;  </span><br><span class="line"> <span class="keyword">begin</span>  </span><br><span class="line"> dbms_space.create_index_cost(  </span><br><span class="line"> <span class="keyword">ddl</span> =&gt;<span class="string">' create index ids_t on user(userid)'</span>,used_bytes=&gt;v_used_bytes,alloc_bytes =&gt;v_alloc_bytes);  </span><br><span class="line"> dbms_output.put_line('used_bytes='||v_used_bytes||' bytes'||' alloc_bytes='|| v_alloc_bytes || ' bytes');  </span><br><span class="line"> <span class="keyword">end</span>;  </span><br><span class="line"> /</span><br></pre></td></tr></table></figure>
<p>另外在建索引的过程中也可以随时监控表空间的使用情况，一旦发现temp表空间不够，可以随时加大</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--查询表空间使用情况</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">UPPER</span>(F.TABLESPACE_NAME) <span class="string">"表空间名"</span>,</span><br><span class="line">D.TOT_GROOTTE_MB <span class="string">"表空间大小(M)"</span>,</span><br><span class="line">D.TOT_GROOTTE_MB - F.TOTAL_BYTES <span class="string">"已使用空间(M)"</span>,</span><br><span class="line">TO_CHAR(<span class="keyword">ROUND</span>((D.TOT_GROOTTE_MB - F.TOTAL_BYTES) / D.TOT_GROOTTE_MB * <span class="number">100</span>,<span class="number">2</span>),<span class="string">'990.99'</span>) <span class="string">"使用比"</span>,</span><br><span class="line">F.TOTAL_BYTES <span class="string">"空闲空间(M)"</span>,</span><br><span class="line">F.MAX_BYTES <span class="string">"最大块(M)"</span></span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">SELECT</span> TABLESPACE_NAME,</span><br><span class="line"><span class="keyword">ROUND</span>(<span class="keyword">SUM</span>(<span class="keyword">BYTES</span>) / (<span class="number">1024</span> * <span class="number">1024</span>), <span class="number">2</span>) TOTAL_BYTES,</span><br><span class="line"><span class="keyword">ROUND</span>(<span class="keyword">MAX</span>(<span class="keyword">BYTES</span>) / (<span class="number">1024</span> * <span class="number">1024</span>), <span class="number">2</span>) MAX_BYTES</span><br><span class="line"><span class="keyword">FROM</span> SYS.DBA_FREE_SPACE</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> TABLESPACE_NAME) F,</span><br><span class="line">(<span class="keyword">SELECT</span> DD.TABLESPACE_NAME,</span><br><span class="line"><span class="keyword">ROUND</span>(<span class="keyword">SUM</span>(DD.BYTES) / (<span class="number">1024</span> * <span class="number">1024</span>), <span class="number">2</span>) TOT_GROOTTE_MB</span><br><span class="line"><span class="keyword">FROM</span> SYS.DBA_DATA_FILES DD</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> DD.TABLESPACE_NAME) D</span><br><span class="line"><span class="keyword">WHERE</span> D.TABLESPACE_NAME = F.TABLESPACE_NAME</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="number">4</span> <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> file_name,<span class="keyword">bytes</span>/<span class="number">1024</span>/<span class="number">1024</span> <span class="string">"MB"</span>,autoextensible,tablespace_name <span class="keyword">from</span> dba_temp_files;</span><br><span class="line"></span><br><span class="line"><span class="comment">--增加表空间大小</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">tablespace</span> <span class="keyword">USERS</span> <span class="keyword">add</span> <span class="keyword">datafile</span> <span class="string">'/opt/ora9/users02.dbf'</span> <span class="keyword">size</span> <span class="number">50</span>M <span class="keyword">autoextend</span> <span class="keyword">on</span> <span class="keyword">next</span> <span class="number">50</span>M <span class="keyword">maxsize</span> <span class="keyword">UNLIMITED</span>;</span><br></pre></td></tr></table></figure>
<p>#3. 使用并行参数</p>
<p>关于利用并行度创建索引，前提是多个CPU，单CPU下用并行度创建索引，可能会造成资源的争用。理论上来说8个CPU, 可以用parallel 6 ,最多占用6个CPU,另外留下两个CPU供其他进程使用。<br>查看CPU核数的方法有很多，详细见（oracle性能优化-CPU篇）。最简单地就是用下面这个sql直接查</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> v$osstat <span class="keyword">where</span> stat_name=<span class="string">'NUM_CPUS'</span>;</span><br></pre></td></tr></table></figure>
<p>#4. 使用nologging</p>
<p>nologging, 绝对应该使用，能减少大量redo log，使速度大幅上升。</p>
<p>于是一个比较标准的并行nologging建索引语句就出炉了。对于生产环境，保险的办法是再加上online参数，避免建索引时的锁对dml产生阻塞。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span>  table_idx <span class="keyword">ON</span> <span class="keyword">table</span> (<span class="keyword">col</span> )  NOLOGGING <span class="keyword">PARALLEL</span> <span class="number">6</span>;</span><br></pre></td></tr></table></figure>
<p><em>Note</em></p>
<blockquote>
<p>对于一个比较大的操作，oracle可能会有等待事件发生<br>首先可以通过sql developer查看等待时间的信息，得到等待时间的p1，p2，p3。然后通过下面的sql转换p1，p2得到具体等待的object。</p>
</blockquote>
<blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">   owner,</span><br><span class="line">   segment_name,</span><br><span class="line">   segment_type</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">   dba_extents</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">   file_id = &amp;P1 <span class="keyword">and</span> &amp;P2 <span class="keyword">between</span> block_id <span class="keyword">and</span> block_id + blocks <span class="number">-1</span>;</span><br></pre></td></tr></table></figure></blockquote>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/08/08/extract-awr/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ario">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/08/08/extract-awr/" class="post-title-link" itemprop="url">AWR 启用和导出</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2014-08-08 00:00:00" itemprop="dateCreated datePublished" datetime="2014-08-08T00:00:00+08:00">2014-08-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-04-09 14:33:48" itemprop="dateModified" datetime="2019-04-09T14:33:48+08:00">2019-04-09</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="1．AWR的启用"><a href="#1．AWR的启用" class="headerlink" title="1．AWR的启用"></a>1．AWR的启用</h1><p>在默认情况下，Oracle启用数据库统计收集这项功能（即启用AWR）。是否启用AWR由初始化参数STATISTICS_LEVEL控制</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SQL&gt; SHOW PARAMETER STATISTICS_LEVEL </span><br><span class="line">NAME                                 TYPE        VALUE</span><br><span class="line"><span class="comment">------------------------------------ ----------- ------------------------------</span></span><br><span class="line">statistics_level                     string      TYPICAL</span><br></pre></td></tr></table></figure>
<p>如果STATISTICS_LEVEL的值为TYPICAL或者 ALL，表示启用AWR；如果STATISTICS_LEVEL的值为BASIC，表示禁用AWR。</p>
<p>初始化参数statistics_level介绍：</p>
<p>AWR的行为受到参数STATISTICS_LEVEL的影响。这个参数有三个值：</p>
<ul>
<li><p>BASIC：awr统计的计算和衍生值关闭.只收集少量的数据库统计信息.</p>
</li>
<li><p>TYPICAL：默认值．只有部分的统计收集.他们代表需要的典型监控oracle数据库的行为.</p>
</li>
<li><p>ALL : 所有可能的统计都被捕捉. 并且有操作系统的一些信息.这个级别的捕捉应该在很少的情况下,比如你要更多的sql诊断信息的时候才使用.</p>
</li>
</ul>
<h1 id="2-导出AWR报告"><a href="#2-导出AWR报告" class="headerlink" title="2. 导出AWR报告"></a>2. 导出AWR报告</h1><ul>
<li>AWR比对报告</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@$ORACLE_HOME/rdbms/admin/awrddrpt.sql</span><br></pre></td></tr></table></figure>
<ul>
<li>RAC全局AWR</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@$ORACLE_HOME/rdbms/admin/awrgrpt.sql</span><br></pre></td></tr></table></figure>
<ul>
<li>本实例的AWR报告，运行脚本awrrpt.sql。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@$ORACLE_HOME/rdbms/admin/awrrpt.sql</span><br></pre></td></tr></table></figure>
<ul>
<li>产生某个实例（RAC）的AWR报告，运行脚本awrrpti.sql。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@$ORACLE_HOME/rdbms/admin/awrrpti.sql</span><br></pre></td></tr></table></figure>
<ul>
<li>产生某条SQL语句的AWR报告，运行脚本awrsqrpt.sql。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@$ORACLE_HOME/rdbms/admin/awrsqrpt.sql</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/04/23/web-log-analyze/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ario">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/04/23/web-log-analyze/" class="post-title-link" itemprop="url">Web 日志分析</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2014-04-23 00:00:00" itemprop="dateCreated datePublished" datetime="2014-04-23T00:00:00+08:00">2014-04-23</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-04-09 14:33:30" itemprop="dateModified" datetime="2019-04-09T14:33:30+08:00">2019-04-09</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-Web业务分析"><a href="#1-Web业务分析" class="headerlink" title="1.    Web业务分析"></a>1.    Web业务分析</h2><p>所有统计分析基于三维原则：</p>
<ul>
<li><p>时间线。所以统计图应有时间线功能。粒度支持到分钟级别。支持时，日，周，月，年切换。支持用户自定义时间</p>
</li>
<li><p>在时间线基础上针对某块业务进行分析，如访客行为，流量趋势，页面访问等。</p>
</li>
<li><p>在以上两个维度上，支持各种基础统计指标（如pv，uv，ip，停留时间等，详见基础统计指标）切换，对比。</p>
</li>
</ul>
<p>###1.1.    综合报告</p>
<p>####1.1.1    网站信息</p>
<p>显示网站的基本信息：</p>
<ol>
<li><p>网站名称</p>
</li>
<li><p>网站地址</p>
</li>
<li><p>开始统计时间</p>
</li>
<li><p>已经统计时间</p>
</li>
</ol>
<p>####1.1.2    最近30天流量趋势</p>
<p>分析从当日至前30日内的PV、UV、IP数据及其变化趋势。系统能根据日，周，月，年切换统计。图表方案可以参照以下形式，所有对比分析的三维数据集图都可沿用以下表现形式，保持一致性，同时支持不同类型的图表切换。</p>
<p>系统实时更新“网站流量”数据中的“今日”、“昨日此时”和 “预计今日”部分中的数据，帮助客户实时了解网站的流量数据；</p>
<p>####1.1.3    访客粘度指标</p>
<p>分别统计分析周，月，年回头客的总量，当前时间区间回头率，平均停留时间，平均访问页数。</p>
<p>###1.2.    最近访客</p>
<p>####1.2.1    访客概要</p>
<p>可以通过访问时间、IP地址、来源地区、来源网址、访问最多的网址等多个维度对访问访客的情况及行为进行分析，页面上显示最多100条的最近访客信息。<br>以（列表？）形式展现</p>
<p>####1.2.2    访客跟踪</p>
<p>可以查看到对应访客最近30分钟内访问的全部页面，详细了解访客的访问轨迹（以visit为单位，每次进入到离开的url轨迹）、访客地区、进入时间、停留时间、访问来源，探索访客的行为规律。</p>
<p>###1.3.    时段分析</p>
<p>时段分析功能，客户可以自定义对24小时内PV、UV、IP数据及变化趋势进行分析，系统会每分钟对该数据进行更新。</p>
<p>时段分析功能分为：</p>
<p>单日流量：可以分析某一天各小时内的PV、UV、IP数据及变化情况。</p>
<p>多日对比：可以分别分析对比选定日期内PV、UV、IP数据及变化情况。</p>
<p>时段趋势：可以选择某段日期区间内分析某一小时时段的PV、UV、IP数据及变化情况。</p>
<p>###1.4.    每日分析</p>
<p>可以按照客户选择的时间，对于本周、上周、本月、上月或任意时间，访客每日访问网站的状况及访客行为进行分析，系统每分钟对数据进行更新。使客户可以最简单、直接的了解站点一定时期内的流量和访客情况。</p>
<p>####1.4.1    每日流量：</p>
<p>分析当日及30日内PV、UV、IP的数据及变化；</p>
<p>####1.4.2    访客平均停留时间：</p>
<p>针对访客行为分析，分析选定时间内访客平均停留时间；</p>
<p>####1.4.3    访客平均访问页数：</p>
<p>针对访客行为分析，分析选定时间内访客平均访问页数；</p>
<p>###1.5.    来源分析</p>
<p>####1.5.1    ip来源</p>
<p>IP来源分析功能，可以记录并分析访问客户网站的IP信息，记录各IP访问的PV量，此功能可以帮助客户更深入的分析来源IP所对应访客的访问行为，及时发现异常或恶意访问的IP。同时，客户可以通过点击页面显示的IP地址查询出该IP所对应的地区名称，IP构成：分析访客IP构成比例(分为直接输入、搜索引擎导入、其他来源导入)。</p>
<p>####1.5.2    访问来源分析</p>
<p>按照不同时间段<br>各访问来源流量：针对所有访客访问来源，对PV、UV、IP、平均访问时间、平均访问页数等访客行为特点进行分析，同时可以显示各来源占总来源的数据比例；<br>指定访问来源流量：针对选择的来源分析该来源带来的流量（PV、UV、IP、平均访问时间、平均访问页数）趋势，</p>
<p>###1.6.    被访主机分析</p>
<p>按照不同时间段分析</p>
<p>1.6.1    各主机流量</p>
<p>对比分析各个主机在PV、UV、IP、平均访问时间、平均访问页数维度上的趋势</p>
<p>1.6.2    指定主机流量</p>
<p>指定某主机分析在PV、UV、IP、平均访问时间、平均访问页数维度上的趋势</p>
<p>###1.7.    被访页面分析</p>
<p>被访页面分析功能，可以按照不同时间段，分别对站内被访问页面流量及趋势进行分析，系统会每小时对该数据进行更新。</p>
<p>####1.7.1    被访页面流量</p>
<p>用来分析站内被访页面流量比例，并按流量大小排序，目前报表中显示被访最多的100个页面信息；</p>
<p>####1.7.2    指定被访页面流量趋势</p>
<p>可以通过输入访问页面url地址，按时间分析该页面流量变化趋势。</p>
<p>###1.8.    访问入口分析</p>
<p>####1.8.1    各访问入口流量：</p>
<p>针对所有访问入口，统计访客从该入口进入网站的次数，并排序显示；</p>
<p>####1.8.2    指定访问入口流量趋势：</p>
<p>输入指定的入口链接，选择统计时间段，可显示该时间段内指定访问入口的入口次数及相应百分比</p>
<p>###1.9.    访问出口分析</p>
<p>####1.9.1    各访问出口流量：</p>
<p>针对所有访问出口，统计访客从该出口离开网站的次数，并排序显示；</p>
<p>####1.9.2    指定访问出口流量趋势：</p>
<p>输入指定的出口链接，选择统计时间段，可显示该时间段内指定访问出口的出口次数及相应百分比。</p>
<p>###1.10.    客户端分析</p>
<p>供客户端时间线分析功能，统计和分析访客浏览器内核、浏览器使用情况。帮助客户更有针对性地设计网站，保证网站前端兼容性。</p>
<p>##2.    基础统计指标</p>
<ol>
<li>PV(访问量)：即Page View, 即页面被打开或请求的次数，访客每次刷新即新增一条web日志就被计算一次，web日志的条数代表PV总量。</li>
</ol>
<p>另：唯一页面浏览次数UPV。主要是避免页面的重复加载和刷新导致Pageviews虚高的情况，所以在同一个Visit当中重复打开同一个页面，该页面的Unique Pageviews始终只被记为1次。</p>
<p>定义visit：<br>同一个访问者（同ip，同浏览器）的两个相邻pageviews之间的时间间隔如果超过了30分钟，会被记录为一个新的visit。<br>一天结束时，持续的浏览行为自动被切分为两个visit。<br>一个访问者更换了与原先来源不同的其他来源再次访问这个网站，也会被记为一个新的visit，即使在30分钟内更换也如此。但更换为直接流量除外，即referer字段为空。</p>
<ol start="2">
<li>UV(独立访客)：即Unique Visitor,访问客户网站的一台电脑客户端（相同ip相同浏览器）为一个访客。00:00-24:00内相同的客户端只被计算一次。主流应使用cookie计算</li>
<li>IP(独立IP)：指独立来源IP。00:00-24:00内相同IP地址只被计算一次。</li>
<li>24小时独立IP：指每小时独立的IP地址。该数据每个小时独立去重。</li>
<li>最高IP : 指选择时间段范围内（用户指定），访问最多的ip</li>
<li>最高PV：指选择时间段范围内（用户指定），某页面访问量最高的数值</li>
<li>新访客：某客户端首次访问（从未访问）为一个新访客。</li>
<li>最近访客：最近一段时间内访问客户网站的客户端。显示100条。</li>
<li>常驻访客：指7天内，一个月内，一年visit高于平均值访问网站的访客。</li>
<li>进入页面：单个访客每一次visit的第一个页面为进入页面。</li>
<li>离开页面：单个访客每一次visit所查看的最后一个页面为离开页面。</li>
<li>进入人次：指从某页面进入网站的人次。</li>
<li>离开人次：指从某页面离开网站的人次。</li>
<li>进入时间：访客每次发起visit进入网站的时间。</li>
<li><p>停留时间：单个访客每次visit从第一个页面到最后离开停留的时间。注：涉及停留时间需要算法支持，主流算法有两种。Google Analytics 采用线性化访问过程的方法。将如下的访问过程线性化，离开的页面停留时间记为0.</p>
<p><img src="http://zxdy-blog.qiniudn.com/stay_time.png" alt="stay"></p>
</li>
</ol>
<p>按时间顺序转化为</p>
<p> <img src="http://zxdy-blog.qiniudn.com/stay_time2.png" alt="stay2"></p>
<ol start="16">
<li>平均停留时间：所有访客的访问过程，访问持续时间的平均值。</li>
<li>平均访问页数：所有访客的访问过程，连续访问页面数的平均值。</li>
<li>回头率：指7天内，一个月内，一年内常驻访客数占总访客数的百分比。</li>
<li>跳失率：表示访客只访问了一个页面就离开的访问次数占该页面总访问次数的比例。</li>
<li>访问来源：访客来访问网站的途径，即访客通过哪种方式进入网站。</li>
<li>访客跟踪：可以查看到对应访客最近30分钟内访问的全部页面，详细了解访客的访问轨迹、访客地区、进入时间、停留时间，访问来源，探索访客的行为规律。<br>22．访客地区比例：每个省市访客占总访客人数的百分比，帮助分析访客地域来源。</li>
</ol>
<p>##3.    日志解析</p>
<p>以下是一条标准的web访问日志。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">218.19.140.242 – - [11/Dec/2013:09:31:17 +0800] “GET /query/p/1/s/-1/ver/ver.html HTTP/1.1″ 200 1933 “-” “Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.9.2.8) Gecko/20100722 Firefox/3.6.8 (.NET CLR 3.5.30729)”</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>字段</th>
<th style="text-align:left">字段值</th>
<th style="text-align:left">字段意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td style="text-align:left">218.19.140.242</td>
<td style="text-align:left">来源ip地址</td>
</tr>
<tr>
<td>2</td>
<td style="text-align:left">-</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td>3</td>
<td style="text-align:left">-</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td>4</td>
<td style="text-align:left">[11/Dec/2013:09:31:17 +0800]</td>
<td style="text-align:left">访问时间</td>
</tr>
<tr>
<td>5</td>
<td style="text-align:left">GET /query/p/1/s/-1/ver/ver.html HTTP/1.1</td>
<td style="text-align:left">访问方法，url地址，http协议版本</td>
</tr>
<tr>
<td>6</td>
<td style="text-align:left">200</td>
<td style="text-align:left">由服务器端发送回客户端状态码</td>
</tr>
<tr>
<td>7</td>
<td style="text-align:left">1933</td>
<td style="text-align:left">这项表示服务器向客户端发送了多少的字节</td>
</tr>
<tr>
<td>8</td>
<td style="text-align:left">-</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td>9</td>
<td style="text-align:left">Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.9.2.8) Gecko/20100722 Firefox/3.6.8 (.NET CLR 3.5.30729)</td>
<td style="text-align:left">记录客户端的浏览器信息</td>
</tr>
</tbody>
</table>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2014/04/14/why-vm-tor-and-vpn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ario">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2014/04/14/why-vm-tor-and-vpn/" class="post-title-link" itemprop="url">为什么虚拟机+tor+vpn</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2014-04-14 00:00:00" itemprop="dateCreated datePublished" datetime="2014-04-14T00:00:00+08:00">2014-04-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-04-09 14:33:06" itemprop="dateModified" datetime="2019-04-09T14:33:06+08:00">2019-04-09</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="为啥要使用虚拟机"><a href="#为啥要使用虚拟机" class="headerlink" title="为啥要使用虚拟机"></a>为啥要使用虚拟机</h2><p>使用虚拟机主要有俩原因。<br>第一个是为了好收拾，清理痕迹什么的。特别是MAC地址，系统指纹信息等等，这些一旦被收集到都可以作为呈堂证供。用虚拟机，干了坏事把快照恢复一下就好，省的清理cookie什么乱七八糟的，如果是干了特别坏的事那就把虚拟机删了，干净清透没问题～</p>
<p>第二个原因是为了做网络隔离。直接连接网络很有可能会暴露你的公网ip地址。很显然在你的主机电脑上装了很多软件。。这些软件不说到底有没有后门，但是记录你的操作记录，或者某些隐私信息妥妥的，有些甚至可以直接绕过代理访问自己的服务器，一旦追查起来，都是很容易取证的。所以套一层虚拟机，搭一个干净的环境可以保护隐私不外泄。还有种双层虚拟机的，虚拟机A用作攻击机，虚拟机B用作网关，B必须是双网卡，一个host-only，一个NAT，然后A的所有信息先通过B中转到host再到公网。好吧，个人感觉这种真的是非常的蛋疼疼疼。。不过确实比单虚拟机更加安全。</p>
<p>##再说tor<br>这个具体干嘛的找谷歌吧，总的来说是一款专门设计用于隐匿上网身份的工具。为什么说它可以用来隐匿呢？咱们来看图<br><img src="http://7x2wf2.com1.z0.glb.clouddn.com/tor.jpg" alt="tor工作图"></p>
<p>tor在全世界有很多的中继节点，就是图中的2部分。当你启动tor用来上网的时候，首先经过1进入中继节点，TOR 客户端会随机挑选三个节点用于中转，并且每过几分钟会重新选择。中继节点分入口节点，中间节点，出口节点，然后再经过3到服务器。在这三步中，1和2都是经过加密的，只有在出口节点能看到你的真实访问信息。如果你访问的是https协议的网站，那就相对安全，因为https是加密的。如果访问的是http协议的网站，那么风险就比较大，因为出口节点说不定是蜜罐，在嗅探你的出口明文信息。但是由于1，2部分中间也都是加密传输，即便出口节点知道有人访问了某网站干了点啥，它也无法定位到来源的ip，除非所有节点都是蜜罐，或者有传说中NSA那样牛逼的破解密钥的能力一路追上来锁定你。</p>
<p>##还有vpn<br>所以为啥还要用vpn啊？用tor感觉已经很安全了啊，即便是侧漏了好像也找不到自己也？</p>
<p>感谢国家。。感谢GFW。。tor这种看上去一点都不像是五好青年用的东西必须肯定是分分钟在GFW的黑名单上啊。。。当你很嗨皮的启动tor想要体验一把“偷偷的上网，打枪地不要”时候，你会发现拓麻一个中继节点都连接不上啊～所以先整个VPN把自己翻出墙吧，然后才能连上tor。</p>
<p>##最后</p>
<p>警察蜀黍说，莫伸手，伸手必被抓。<br>这世上没有绝对的安全，丝绸之路创始人用tor如此high，还不是进去了。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2013/12/18/debug-Pipelined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ario">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2013/12/18/debug-Pipelined/" class="post-title-link" itemprop="url">sql developer怎样调试Pipelined</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2013-12-18 00:00:00" itemprop="dateCreated datePublished" datetime="2013-12-18T00:00:00+08:00">2013-12-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-04-09 14:32:05" itemprop="dateModified" datetime="2019-04-09T14:32:05+08:00">2019-04-09</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在sql developer中，如果直接对pipelined语句进行断点debug会报错，那么怎样可以解决这个问题呢？可以用procedure包住这个函数，再进行单步调试。下面是演示的demo。  </p>
<h2 id="准备pipelined"><a href="#准备pipelined" class="headerlink" title="准备pipelined"></a>准备pipelined</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CREATE TYPE t_tf_row AS OBJECT (</span><br><span class="line">  id           NUMBER,</span><br><span class="line">  description  VARCHAR2(50)</span><br><span class="line">);</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">CREATE TYPE t_tf_tab IS TABLE OF t_tf_row;</span><br><span class="line">/</span><br><span class="line"></span><br><span class="line">CREATE OR REPLACE FUNCTION get_tab_ptf (p_rows IN NUMBER) RETURN t_tf_tab PIPELINED AS</span><br><span class="line">BEGIN</span><br><span class="line">  FOR i IN 1 .. p_rows LOOP</span><br><span class="line">    PIPE ROW(t_tf_row(i, &apos;Description for &apos; || i));   </span><br><span class="line">  END LOOP;</span><br><span class="line"></span><br><span class="line">  RETURN;</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<h2 id="然后用procedure包住这个get-tab-ptf函数"><a href="#然后用procedure包住这个get-tab-ptf函数" class="headerlink" title="然后用procedure包住这个get_tab_ptf函数"></a>然后用procedure包住这个get_tab_ptf函数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE OR REPLACE</span><br><span class="line">PROCEDURE test_pipeline</span><br><span class="line">IS</span><br><span class="line">BEGIN</span><br><span class="line">  FOR cur_rec IN (SELECT *  FROM  TABLE(get_tab_ptf(10)))</span><br><span class="line">  LOOP</span><br><span class="line">    dbms_output.put_line(&apos;get one row!&apos;);</span><br><span class="line">  END LOOP;</span><br><span class="line">END;</span><br></pre></td></tr></table></figure>
<h2 id="断点位置"><a href="#断点位置" class="headerlink" title="断点位置"></a>断点位置</h2><p>最后将断点打在test_pipeline的for循环上，对这个procedure进行单步调试就可以跳转到函数get_tab_ptf内部了。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2013/12/18/locate-exception-line/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ario">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2013/12/18/locate-exception-line/" class="post-title-link" itemprop="url">oracle 存储过程显示异常行</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2013-12-18 00:00:00" itemprop="dateCreated datePublished" datetime="2013-12-18T00:00:00+08:00">2013-12-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-04-09 14:32:36" itemprop="dateModified" datetime="2019-04-09T14:32:36+08:00">2019-04-09</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>记一个写pl/sql比较有用的技巧。当oracle的存储过程运行出现异常的时候，虽然可以被exception抓到，但是无法定位究竟是在之前的业务处理逻辑代码哪一行出现了问题，调试起来不方便。比如下面的demo运行之后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CREATE OR REPLACE</span><br><span class="line">  FUNCTION FUNC</span><br><span class="line">    RETURN NUMBER</span><br><span class="line">  AS</span><br><span class="line">    v_in NUMBER;</span><br><span class="line">    v_out NUMBER;</span><br><span class="line"></span><br><span class="line">  BEGIN</span><br><span class="line">    v_in :=12;</span><br><span class="line">    dbms_output.put_line(v_in);</span><br><span class="line">    v_out:=v_in/0;</span><br><span class="line">    RETURN v_out;</span><br><span class="line">  EXCEPTION</span><br><span class="line">  WHEN OTHERS THEN</span><br><span class="line">    dbms_output.put_line(&apos;######exception:&apos;);</span><br><span class="line">  END FUNC;</span><br></pre></td></tr></table></figure>
<p>显示的结果如下，并没有显示真正异常的代码行号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Connecting to the database dev74.</span><br><span class="line">ORA-06503: PL/SQL: Function returned without value</span><br><span class="line">ORA-06512: at &quot;TLSPID.FUNC&quot;, line 16</span><br><span class="line">ORA-06512: at line 5</span><br><span class="line">12</span><br><span class="line">######exception:</span><br><span class="line">Process exited.</span><br><span class="line">Disconnecting from the database dev74.</span><br></pre></td></tr></table></figure>
<p>但是只要在exception代码块中加上第16行的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">CREATE OR REPLACE</span><br><span class="line">  FUNCTION FUNC</span><br><span class="line">    RETURN NUMBER</span><br><span class="line">  AS</span><br><span class="line">    v_in NUMBER;</span><br><span class="line">    v_out NUMBER;</span><br><span class="line"></span><br><span class="line">  BEGIN</span><br><span class="line">    v_in :=12;</span><br><span class="line">    dbms_output.put_line(v_in);</span><br><span class="line">    v_out:=v_in/0;</span><br><span class="line">    RETURN v_out;</span><br><span class="line">  EXCEPTION</span><br><span class="line">  WHEN OTHERS THEN</span><br><span class="line">    dbms_output.put_line(&apos;######exception:&apos;);</span><br><span class="line">    dbms_output.put_line(dbms_utility.format_error_backtrace());</span><br><span class="line">  END FUNC;</span><br></pre></td></tr></table></figure>
<p>运行后结果如下，可以看到第7行显示了出错的地方。实际使用的时候注意出错的行号应该是报错的下一行。比如下面显示第10行报错，但实际应该是第11行出错。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Connecting to the database dev74.</span><br><span class="line">ORA-06503: PL/SQL: Function returned without value</span><br><span class="line">ORA-06512: at &quot;TLSPID.FUNC&quot;, line 16</span><br><span class="line">ORA-06512: at line 5</span><br><span class="line">12</span><br><span class="line">######exception:</span><br><span class="line">ORA-06512: at &quot;TLSPID.FUNC&quot;, line 10</span><br><span class="line">Process exited.</span><br><span class="line">Disconnecting from the database dev74.</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2013/12/13/dbms_output-in-java-console/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ario">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2013/12/13/dbms_output-in-java-console/" class="post-title-link" itemprop="url">oracle dbms_output 在java中输出</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2013-12-13 00:00:00" itemprop="dateCreated datePublished" datetime="2013-12-13T00:00:00+08:00">2013-12-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-04-09 15:20:58" itemprop="dateModified" datetime="2019-04-09T15:20:58+08:00">2019-04-09</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>有没有碰到过这种情况，当你的java程序连接oracle运行存储过程的时候，java控制台只是仅仅输出java程序的相关信息，<br>而存储过程中的dbms_output内容却没有办法显示？这样只能跑去sql developer 单独调试存储过程，而不能直接在eclipse<br>进行集成测试，出了问题也不好定位。  </p>
<p>所以在此分享一个解决方案： <a href="http://asktom.oracle.com/pls/asktom/f?p=100:11:0::::P11_QUESTION_ID:45027262935845" target="_blank" rel="noopener">原文链接</a> 。05年的一个方法，不知现在有没有更好的：）  </p>
<h2 id="存储过程demo"><a href="#存储过程demo" class="headerlink" title="存储过程demo"></a>存储过程demo</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create or replace</span><br><span class="line">PROCEDURE test_java_dbmsOutPut</span><br><span class="line">IS</span><br><span class="line">BEGIN</span><br><span class="line">   dbms_output.put_line(&apos;im in store procedure&apos;);</span><br><span class="line">END;</span><br><span class="line">/</span><br></pre></td></tr></table></figure>
<h2 id="用来输出dbms-output-的类"><a href="#用来输出dbms-output-的类" class="headerlink" title="用来输出dbms_output 的类"></a>用来输出dbms_output 的类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DbmsOutput</span> </span></span><br><span class="line"><span class="class"> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * our instance variables. It is always best to use callable or prepared</span></span><br><span class="line"><span class="comment">     * statements and prepare (parse) them once per program execution, rather</span></span><br><span class="line"><span class="comment">     * then one per execution in the program. The cost of reparsing is very</span></span><br><span class="line"><span class="comment">     * high. Also -- make sure to use BIND VARIABLES!</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * we use three statments in this class. One to enable dbms_output -</span></span><br><span class="line"><span class="comment">     * equivalent to SET SERVEROUTPUT on in SQL*PLUS. another to disable it --</span></span><br><span class="line"><span class="comment">     * like SET SERVEROUTPUT OFF. the last is to "dump" or display the results</span></span><br><span class="line"><span class="comment">     * from dbms_output using system.out</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> CallableStatement enable_stmt;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> CallableStatement disable_stmt;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> CallableStatement show_stmt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * our constructor simply prepares the three statements we plan on</span></span><br><span class="line"><span class="comment">     * executing.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * the statement we prepare for SHOW is a block of code to return a String</span></span><br><span class="line"><span class="comment">     * of dbms_output output. Normally, you might bind to a PLSQL table type but</span></span><br><span class="line"><span class="comment">     * the jdbc drivers don't support PLSQL table types -- hence we get the</span></span><br><span class="line"><span class="comment">     * output and concatenate it into a string. We will retrieve at least one</span></span><br><span class="line"><span class="comment">     * line of output -- so we may exceed your MAXBYTES parameter below. If you</span></span><br><span class="line"><span class="comment">     * set MAXBYTES to 10 and the first line is 100 bytes long, you will get the</span></span><br><span class="line"><span class="comment">     * 100 bytes. MAXBYTES will stop us from getting yet another line but it</span></span><br><span class="line"><span class="comment">     * will not chunk up a line.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DbmsOutput</span><span class="params">(Connection conn)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        enable_stmt = conn.prepareCall(<span class="string">"begin dbms_output.enable(:1); end;"</span>);</span><br><span class="line">        disable_stmt = conn.prepareCall(<span class="string">"begin dbms_output.disable; end;"</span>);</span><br><span class="line">        show_stmt =</span><br><span class="line">            conn.prepareCall(<span class="string">"declare "</span></span><br><span class="line">                + <span class="string">"    l_line varchar2(255); "</span></span><br><span class="line">                + <span class="string">"    l_done number; "</span></span><br><span class="line">                + <span class="string">"    l_buffer long; "</span></span><br><span class="line">                + <span class="string">"begin "</span></span><br><span class="line">                + <span class="string">"  loop "</span></span><br><span class="line">                + <span class="string">"    exit when length(l_buffer)+255 &gt; :maxbytes OR l_done = 1; "</span></span><br><span class="line">                + <span class="string">"    dbms_output.get_line( l_line, l_done ); "</span></span><br><span class="line">                + <span class="string">"    l_buffer := l_buffer || l_line || chr(10); "</span></span><br><span class="line">                + <span class="string">"  end loop; "</span> + <span class="string">" :done := l_done; "</span></span><br><span class="line">                + <span class="string">" :buffer := l_buffer; "</span> + <span class="string">"end;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * enable simply sets your size and executes the dbms_output.enable call</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enable</span><span class="params">(<span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        enable_stmt.setInt(<span class="number">1</span>, size);</span><br><span class="line">        enable_stmt.executeUpdate();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * disable only has to execute the dbms_output.disable call</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disable</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        disable_stmt.executeUpdate();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * show does most of the work. It loops over all of the dbms_output data,</span></span><br><span class="line"><span class="comment">     * fetching it in this case 32,000 bytes at a time (give or take 255 bytes).</span></span><br><span class="line"><span class="comment">     * It will print this output on stdout by default (just reset what</span></span><br><span class="line"><span class="comment">     * System.out is to change or redirect this output).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> done = <span class="number">0</span>;</span><br><span class="line">        show_stmt.registerOutParameter(<span class="number">2</span>, java.sql.Types.INTEGER);</span><br><span class="line">        show_stmt.registerOutParameter(<span class="number">3</span>, java.sql.Types.VARCHAR);</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            show_stmt.setInt(<span class="number">1</span>, <span class="number">32000</span>);</span><br><span class="line">            show_stmt.executeUpdate();</span><br><span class="line">            System.out.print(show_stmt.getString(<span class="number">3</span>));</span><br><span class="line">            <span class="keyword">if</span> ((done = show_stmt.getInt(<span class="number">2</span>)) == <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * close closes the callable statements associated with the DbmsOutput</span></span><br><span class="line"><span class="comment">     * class. Call this if you allocate a DbmsOutput statement on the stack and</span></span><br><span class="line"><span class="comment">     * it is going to go out of scope -- just as you would with any callable</span></span><br><span class="line"><span class="comment">     * statement, result set and so on.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        enable_stmt.close();</span><br><span class="line">        disable_stmt.close();</span><br><span class="line">        show_stmt.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        DriverManager.registerDriver(<span class="keyword">new</span> oracle.jdbc.driver.OracleDriver());</span><br><span class="line">        Connection conn = DBAgent.getConn(); </span><br><span class="line">        conn.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line">        Statement stmt = conn.createStatement();</span><br><span class="line">        DbmsOutput dbmsOutput = <span class="keyword">new</span> DbmsOutput(conn);</span><br><span class="line">        dbmsOutput.enable(<span class="number">1000000</span>);</span><br><span class="line">        stmt.execute("begin test_java_dbmsOutPut; end;"); #调用存储过程</span><br><span class="line">        stmt.close();</span><br><span class="line">        dbmsOutput.show(); #显示DBMS_OUTPUT</span><br><span class="line">        dbmsOutput.close();</span><br><span class="line">        conn.close();</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="输出的结果"><a href="#输出的结果" class="headerlink" title="输出的结果"></a>输出的结果</h2><p>运行测试代码之后，就可以看见在java 控制台输出了: <strong>im in store procedure</strong></p>
<blockquote>
<p>这样就可以让java为我们输出DBMS_OUTPUT，就像SQL*PLUS一样。你需要做的仅仅是在java运行存储过程之后，调用DbmsOutput.show() ，就能显示这个存储过程内的DBMS_OUTPUT，是不是很方便？再也不用在eclipse和sql develper之间两头调试了</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Ario</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">21</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ario</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/affix.js?v=7.1.0"></script>

  <script src="/js/schemes/pisces.js?v=7.1.0"></script>




  

  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  



  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
